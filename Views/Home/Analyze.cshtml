@model SmartJobRecommender.Models.ViewModels.AnalyzeViewModel
@using SmartJobRecommender.Models.ViewModels

@{
    ViewData["Title"] = "Resume Analyzer";
}

<style>
    /* Add the necessary spinner styles here for the loader to work */
    .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3b82f6; /* Blue */
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .prose h4 {
        font-size: 1.25rem;
        font-weight: 700;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #1f2937; /* Dark gray */
    }

    .prose ul {
        list-style-type: disc;
        padding-left: 1.5rem;
        margin-top: 0.5rem;
    }

    .prose li {
        margin-bottom: 0.5rem;
        color: #4b5563;
    }

    .prose strong {
        font-weight: 600;
    }
</style>

<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">

    <!-- Upload & Analysis Section (Always Visible if not completed) -->
    <section id="upload-section" class="bg-white p-8 rounded-xl shadow-md @(Model.AnalysisCompleted ? "hidden" : "")">
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-900">Chart Your Path to Your Dream Job</h1>
            <p class="mt-2 text-lg text-gray-600">Upload your resume, tell us your goal, and let our AI do the rest.</p>
        </div>

        <div class="mt-8 space-y-6">
            <!-- Ensure enctype="multipart/form-data" for file uploads -->
            <form asp-action="Analyze" method="post" enctype="multipart/form-data">

                <div asp-validation-summary="ModelOnly" class="text-red-500 mb-4 text-sm text-center"></div>

                <!-- Step 1: Upload Resume -->
                <div>
                    <label asp-for="ResumeFile" class="block text-lg font-semibold text-gray-800 mb-2"></label>
                    <div id="file-upload-area" class="file-upload-area rounded-lg p-8 text-center cursor-pointer hover:bg-gray-50 border-2 border-dashed border-gray-300">
                        <input asp-for="ResumeFile" type="file" id="resume-file-input" class="hidden" accept=".pdf,.docx">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">
                            <span class="font-semibold text-blue-600">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500">PDF or DOCX accepted</p>
                        <p id="file-name" class="mt-2 text-sm font-medium text-green-700"></p>
                    </div>
                    <span asp-validation-for="ResumeFile" class="text-red-500 text-sm"></span>
                </div>

                <!-- Step 2: Enter Dream Job -->
                <div>
                    <label asp-for="DreamJobTitle" class="block text-lg font-semibold text-gray-800 mb-2"></label>
                    <input asp-for="DreamJobTitle" class="w-full px-4 py-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-lg" placeholder="e.g., Data Scientist, UX Designer...">
                    <span asp-validation-for="DreamJobTitle" class="text-red-500 text-sm"></span>
                </div>

                <!-- Step 3: Analyze -->
                <div>
                    <button type="submit" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold text-lg px-8 py-4 rounded-lg shadow-lg hover:bg-blue-700 transform hover:scale-105 transition-all">
                        <span>✨</span> Analyze My Path
                    </button>
                </div>
            </form>
        </div>
    </section>

    <!-- Results Section (Visible after AnalysisCompleted is true) -->
    @if (Model.AnalysisCompleted)
    {
        <section id="results-section" class="mt-8 fade-in">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Analysis Complete!</h2>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Column 1: Extracted Skills -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-blue-600 border-b pb-3 mb-4">Your Extracted Skills (@Model.ExtractedSkills.Count)</h3>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var skill in Model.ExtractedSkills)
                        {
                            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">@skill</span>
                        }
                    </div>
                </div>

                <!-- Column 2 & 3: Job Recommendations -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-xl font-bold text-green-600 border-b pb-3 mb-4">Top Job Recommendations</h3>
                    <p class="text-gray-600 mb-4">These jobs align best with your current skill profile:</p>

                    <div class="space-y-4">
                        @if (!Model.RecommendedJobs.Any())
                        {
                            <p class="text-red-500">No matching jobs found. Try adding more jobs and skills in the Admin panel.</p>
                        }
                        @foreach (var job in Model.RecommendedJobs)
                        {
                            <div class="p-4 border border-gray-200 rounded-lg shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="text-lg font-bold text-gray-900">@job.Title (@job.Company)</h4>
                                        <p class="text-sm text-gray-500">@job.Location</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-extrabold @(job.MatchScore >= 80 ? "text-green-500" : (job.MatchScore >= 50 ? "text-yellow-500" : "text-red-500"))">
                                            @job.MatchScore%
                                        </p>
                                        <p class="text-xs text-gray-500">Match</p>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <p class="font-semibold text-sm">Skills Needed (Missing: @job.MissingSkills.Count)</p>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        @foreach (var skill in job.RequiredSkills)
                                        {
                                            // Check if the user has the skill by comparing to the extracted list
                                            var hasSkill = Model.ExtractedSkills.Any(s => s.Equals(skill, StringComparison.OrdinalIgnoreCase));
                                            <span class="text-xs px-2 py-0.5 rounded @(hasSkill ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800 font-semibold")">
                                                @skill
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Dream Job Gap Analysis Section (Now calls the C# Endpoint) -->
            <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-2xl font-bold text-indigo-600 border-b pb-3 mb-4">Path to Dream Job: @Model.DreamJobTitle</h3>

                <div id="analysis-results-container">
                    @if (!string.IsNullOrEmpty(Model.DreamJobAnalysisResult))
                    {
                        <div class="prose max-w-none">
                            @Html.Raw(Model.DreamJobAnalysisResult)
                        </div>
                    }
                </div>

                <div id="analysis-loader" class="hidden mt-4 text-center">
                    <div class="inline-block loader mr-2"></div>
                    <p class="text-gray-600">Analyzing skills against market requirements...</p>
                </div>

                <!-- Anti-forgery token is required for AJAX POST to the GenerateDreamJobAnalysis endpoint -->
                @Html.AntiForgeryToken()
                <button id="run-dream-job-analysis-btn" data-job-title="@Model.DreamJobTitle" class="mt-4 w-full bg-indigo-600 text-white px-4 py-3 rounded-md hover:bg-indigo-700 transition-colors">
                    ✨ Run Gap Analysis & Course Suggestion
                </button>
            </div>

        </section>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // JS logic to display file name and handle the second AI call
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('resume-file-input');
            const fileNameDisplay = document.getElementById('file-name');
            const fileUploadArea = document.getElementById('file-upload-area');

            // Display selected file name
            if (fileInput) {
                fileInput.addEventListener('change', function () {
                    if (this.files.length > 0) {
                        fileNameDisplay.textContent = 'Selected: ' + this.files[0].name;
                        fileUploadArea.classList.add('border-blue-500', 'bg-blue-50');
                    } else {
                        fileNameDisplay.textContent = '';
                        fileUploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                    }
                });
            }

            // --- Second AI Call (Dream Job Gap Analysis) ---
            const runAnalysisBtn = document.getElementById('run-dream-job-analysis-btn');
            if (runAnalysisBtn) {
                runAnalysisBtn.addEventListener('click', async function () {
                    const jobTitle = this.dataset.jobTitle;
                    const loader = document.getElementById('analysis-loader');
                    const resultsContainer = document.getElementById('analysis-results-container');

                    loader.classList.remove('hidden');
                    this.disabled = true;
                    resultsContainer.innerHTML = '';

                    // Get the anti-forgery token from the hidden input field generated by @Html.AntiForgeryToken()
                    const antiForgeryToken = document.querySelector('input[name="__RequestVerificationToken"]').value;

                    try {
                        const response = await fetch('@Url.Action("GenerateDreamJobAnalysis", "Home")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': antiForgeryToken
                            },
                            body: JSON.stringify({ dreamJobTitle: jobTitle })
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Convert Markdown from the C# endpoint response to simple HTML
                            let htmlResult = data.result
                                .replace(/\r?\n\r?\n/g, '<br><br>')
                                .replace(/### (.*)/g, '<h4>$1</h4>')
                                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

                            resultsContainer.innerHTML = `<div class="prose max-w-none">${htmlResult}</div>`;

                        } else {
                            resultsContainer.innerHTML = `<p class="text-red-500">${data.message || "An unknown error occurred during AI analysis."}</p>`;
                        }

                    } catch (error) {
                        resultsContainer.innerHTML = '<p class="text-red-500">Failed to connect to the analysis service.</p>';
                        console.error('Fetch Error:', error);
                    } finally {
                        loader.classList.add('hidden');
                        this.disabled = false;
                    }
                });
            }
        });
    </script>
}